<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jurek36AI ChatBot 2.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">


  <style>
    /* Custom scrollbar for better appearance */
    #chat::-webkit-scrollbar {
      width: 8px;
    }
    #chat::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    #chat::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
    }
    #chat::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Animated Gradient Background - Ciemny motyw */
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: linear-gradient(-45deg, #1a202c, #2d3748, #2a4365, #2b6cb0);
      background-size: 400% 400%;
      animation: gradientAnimation 15s ease infinite;
      color: #e2e8f0; /* Jasny kolor tekstu dla ciemnego tła */
    }

    @keyframes gradientAnimation {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    /* Center and constrain the chat container */
    .chat-container-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 1rem;
        width: 100%;
    }

    .chat-container {
        width: 100%;
        max-width: 500px;
        background-color: rgba(30, 41, 59, 0.9);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
        border-radius: 1rem;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 90vh;
        max-height: 700px;
    }

    /* Header styling */
    .chat-header {
      background: rgba(45, 55, 72, 0.8);
      color: white;
      padding: 1.5rem;
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1.rem;
      position: relative;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 0.75rem;
    }

    /* Header title styling */
    .chat-header h1 {
        margin: 0;
        text-align: left;
        color: #e2e8f0;
    }

    /* Styl dla logo w nagłówku (element img) */
    .header-logo {
        height: 5rem;
        width: auto;
        border-radius: 0.25rem;
    }

    /* New Chat Button Styling */
    .new-chat-button {
        background-color: rgba(71, 85, 105, 0.8);
        border: none;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease-in-out;
    }

    .new-chat-button:hover {
        background-color: rgba(45, 55, 72, 0.8);
    }

    /* Styl dla przycisku przełączania kreatywności (ikona) */
    .creativity-toggle-button {
        background-color: rgba(71, 85, 105, 0.8); /* Szare tło (domyślne) */
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 0.5rem;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.2s ease-in-out;
        margin-left: auto;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .creativity-toggle-button:hover {
        background-color: rgba(45, 55, 72, 0.8);
    }

    /* Styl dla aktywnego przycisku kreatywności (niebieski) */
    .creativity-toggle-button.active {
        background-color: rgba(66, 153, 225, 0.9); /* blue-400 z przezroczystością */
    }

    .creativity-toggle-button.active:hover {
         background-color: rgba(49, 130, 189, 0.9); /* blue-500 z przezroczystością */
    }


    /* Usunięto style dla sekcji ustawień persony */

    /* Ukryj standardowe pole input file */
    #image-input {
        display: none;
    }

    /* Styl dla podglądu obrazu */
    .image-preview {
        max-width: 100%;
        max-height: 100px;
        object-fit: contain;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    /* Main chat area styling */
    .chat-main {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        space-y: 1rem;
        background-color: rgba(30, 41, 59, 0.7);
    }

    /* Footer styling */
    .chat-footer {
        padding: 1rem;
        background-color: rgba(45, 55, 72, 0.9);
        border-top: 1px solid #4a5568;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Input styling */
    .chat-input {
        flex: 1;
        padding: 0.5rem 1rem;
        border: 1px solid #4a5568;
        background-color: rgba(74, 85, 104, 0.5);
        color: #e2e8f0;
        border-radius: 0.5rem;
        outline: none;
        transition: border-color 0.2s ease-in-out, ring-color 0.2s ease-in-out;
        min-width: 0;
    }
    .chat-input::placeholder {
      color: #a0aec0;
    }
    .chat-input:focus {
        border-color: #63b3ed;
        ring: 2px;
        ring-color: #90cdf4;
        background-color: rgba(74, 85, 104, 0.7);
    }
    .chat-input:disabled {
        background-color: #2d3748;
        cursor: not-allowed;
        color: #a0aec0;
    }

    /* Styl dla przycisku spinacza (załączania plików) */
    .attach-button {
        background: none;
        border: none;
        color: #90cdf4;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: color 0.2s ease-in-out;
    }

    .attach-button:hover {
        color: #63b3ed;
    }

    /* Send button styling */
    .chat-send-button {
        padding: 0.5rem 1rem;
        background-color: #4299e1;
        color: white;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease-in-out;
        border: none;
        cursor: pointer;
    }
    .chat-send-button:hover {
        background-color: #3182ce;
    }
    .chat-send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Message bubble styling */
    .message-bubble {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      max-width: 80%;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message-bubble.user {
      background-color: rgba(66, 153, 225, 0.9);
      color: white;
      border-top-right-radius: 0;
    }

    .message-bubble.bot {
      background-color: rgba(74, 85, 104, 0.9);
      color: #e2e8f0;
      border-top-left-radius: 0;
    }

    /* Style dla bloków kodu z numerami linii i przyciskiem kopiowania */
    .code-container {
        display: flex;
        position: relative;
        border-radius: 0.5rem;
        overflow: hidden;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
        background-color: #2d3748;
    }

    .line-numbers {
        flex-shrink: 0;
        width: 2.5rem;
        padding: 0.75rem 0.5rem;
        background-color: rgba(45, 55, 72, 0.8);
        color: #a0aec0;
        text-align: right;
        font-family: 'Fira Code', 'Cascadia Code', 'Source Code Pro', monospace;
        font-size: 0.8rem;
        line-height: 1.4;
        user-select: none;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        border-right: 1px solid rgba(71, 85, 105, 0.8);
    }

    .line-numbers span {
        height: 1.4em;
    }

    .code-container pre {
      flex-grow: 1;
      padding: 0.75rem;
      margin: 0;
      overflow-x: auto;
    }

    .code-container pre code {
      font-family: 'Fira Code', 'Cascadia Code', 'Source Code Pro', monospace;
      font-size: 0.9rem;
      line-height: 1.4;
      display: block;
    }

    .copy-button {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out;
        z-index: 1;
    }

    .code-container:hover .copy-button {
        opacity: 1;
    }

    .copy-button:hover {
        background-color: rgba(255, 255, 255, 0.4);
    }

    .copy-button.copied {
        background-color: #48bb78;
        color: white;
    }

    /* Style dla sugerowanych pytań */
    .suggested-questions {
        margin-top: 1rem;
        padding-top: 0.5rem;
        border-top: 1px solid #4a5568;
        font-size: 0.9rem;
        color: #a0aec0;
    }

    .suggested-questions p {
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #e2e8f0;
    }

    .suggested-questions button {
        background-color: rgba(66, 153, 225, 0.1);
        color: #90cdf4;
        border: 1px solid rgba(66, 153, 225, 0.3);
        border-radius: 0.5rem;
        padding: 0.25rem 0.75rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }

    .suggested-questions button:hover {
        background-color: rgba(66, 153, 225, 0.2);
    }

    /* Animacja wskaźnika ładowania */
    .animate-typing::after {
      content: '...';
      animation: typing 1s infinite steps(1);
    }

    @keyframes typing {
      0% { content: '.'; }
      33% { content: '..'; }
      66% { content: '...'; }
      100% { content: '.'; }
    }

  </style>
</head>
<body>
  <div class="chat-container-wrapper">
    <div class="chat-container">
      <header class="chat-header">
        <button id="new-chat-btn" class="new-chat-button" aria-label="Nowy czat">
            <i class="fas fa-plus"></i> </button>
        <img src="https://i.postimg.cc/rFgBD37y/file-00000000eef061f4966205833b4b6822-removebg-preview.png" alt="Jurek36AI Chatbot Logo" class="header-logo">
        <h1>Jurek36AI ChatBot 2.0</h1> <button id="creativity-toggle-btn" class="creativity-toggle-button" aria-label="Przełącz kreatywność">
             <i class="fas fa-cog"></i> </button>
      </header>

      <input type="file" id="image-input" accept="image/*">
       <img id="image-preview" class="image-preview hidden" src="#" alt="Podgląd obrazu">


      <main id="chat" class="chat-main">
        </main>
      <footer class="chat-footer">
        <button id="attach-button" class="attach-button" aria-label="Załącz plik">
             <i class="fas fa-paperclip"></i> </button>
        <input id="message" type="text" placeholder="Napisz wiadomość..."
               class="chat-input" />
        <button id="send" class="chat-send-button">
          Wyślij
        </button>
      </footer>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <script>
    // !!! === BARDZO WAŻNE OSTRZEŻENIA BEZPIECZEŃSTWA === !!!
    // PONIŻEJ MUSISZ WPROWADZIĆ SWÓJ KLUCZ API GOOGLE GEMINI.
    // UMIESZCZANIE KLUCZA API BEZPOŚREDNIO W KODZIE KLIENTA (FRONTENDU)
    // JEST BARDZO NIEBEZPIECZNE! KAZDY, KTO OTWORZY KONSOLĘ PRZEGLĄDARKĘ,
    // BĘDZIE MÓGŁ ZOBACZYĆ I UKRAŚĆ TWÓJ KLUCZ.
    // ZALECAM UŻYCIE TEGO ROZWIĄZANIA TYLKO DO TESTÓW/ROWOJU LOKALNEGO.
    // DLA APLIKACJI PRODUKCYJNYCH ZAWSZE UŻYWAJ BEZPIECZNEGO BACKENDU,
    // KTÓRY BĘDZIE PRZECHOWYWAŁ KLUCZ API I POŚREDNICZYŁ W KOMUNIKACJI.
    const GEMINI_API_KEY = 'AIzaSyChSd5TnsmPwLYZAQclq_al2WC4KVULWNg'; // <--- TUTAJ WPROWADŹ SWÓJ KLUCZ API GOOGLE GEMINI

    const chat = document.getElementById('chat');
    const messageInput = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    const newChatBtn = document.getElementById('new-chat-btn');
    const imageInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview');
    const attachButton = document.getElementById('attach-button');
    const creativityToggleBtn = document.getElementById('creativity-toggle-btn');

    // Usunięto zmienne dla elementów audio
    // const sendSound = document.getElementById('send-sound');
    // const receiveSound = document.getElementById('receive-sound');


    let loadingMessageElement = null;
    let currentLanguage = 'pl';

    // *** ZMIENNA DO PRZECHOWYWANIA HISTORII ROZMOWY ***
    let conversationHistory = [];
    // *** Limit historii rozmowy (liczba tur: użytkownik + bot = 2 wiadomości) ***
    const HISTORY_LIMIT = 20;
    const LOCAL_STORAGE_HISTORY_KEY = 'jurek36ai_chat_history';

    // Wartości kreatywności i aktualny stan
    const DEFAULT_TEMPERATURE = 0.6;
    const MAX_TEMPERATURE = 1.0;
    let currentTemperature = DEFAULT_TEMPERATURE;


    // Marked.js configuration
    marked.setOptions({
      breaks: true,
      gfm: true,
      highlight: function(code, lang) {
        const language = highlight.getLanguage(lang) ? lang : 'plaintext';
        try {
          return highlight.highlight(code, { language }).value;
        } catch (e) {
          console.error("Highlighting error:", e);
          return code;
        }
      },
    });

    // Dictionary of translations
    const translations = {
      'pl': {
        systemMessage: 'Jesteś pomocnym asystentem, który mówi po polsku. Gdy odpowiadasz, możesz używać formatowania Markdown takiego jak **pogrubienie**, *kursywa*, `kod inline` lub bloki kodu:\n```javascript\nconsole.log("Witaj!");\n```\n. Twój język jest polski.',
        inputPlaceholder: 'Napisz wiadomość...',
        sendButtonText: 'Wyślij',
        loadingText: 'Jurek36AI 2.0 pisze',
        errorGeneric: 'Wystąpił nieoczekiwany błąd komunikacji.',
        errorApi: 'Błąd API Gemini.',
        errorApiRequest: 'Błąd żądania (400). Upewnij się, że Twój klucz API i treść żądania są poprawne.',
        errorApiAuth: 'Błąd autoryzacji (401). Sprawdź swój klucz API Gemini.',
        errorApiQuota: 'Przekroczono limit zapytań (429). Spróbuj ponownie później.',
        errorApiServer: (status) => `Błąd serwera Gemini (HTTP ${status}). Spróbuj ponownie później.`,
        errorNoReply: 'Nie otrzymano odpowiedzi tekstowej od bota Gemini.',
        copyButtonText: 'Kopiuj',
        copiedButtonText: 'Skopiowano!',
        suggestedQuestionsTitle: 'Możesz zapytać:',
        creativityNormal: 'Normalna Kreatywność',
        creativityMax: 'Maksymalna Kreatywność',
      },
      'en': {
        systemMessage: 'You are a helpful assistant who speaks English. When responding, you can use Markdown formatting like **bold**, *italics*, `inline code` or code blocks:\n```javascript\nconsole.log("Hello!");\n```\n. Your language is English.',
        inputPlaceholder: 'Write a message...',
        sendButtonText: 'Send',
        loadingText: 'Jurek36AI 2.0 is typing',
        errorGeneric: 'An unexpected communication error occurred.',
        errorApi: 'Gemini API Error.',
        errorApiRequest: 'Bad request (400). Ensure your API key and request body are correct.',
        errorApiAuth: 'Authorization error (401). Check your Gemini API key.',
        errorApiQuota: 'Quota exceeded (429). Try again later.',
        errorApiServer: (status) => `Gemini server error (HTTP ${status}). Please try again later.`,
        errorNoReply: 'No text reply received from Gemini bot.',
        copyButtonText: 'Copy',
        copiedButtonText: 'Copied!',
        suggestedQuestionsTitle: 'You can ask:',
        creativityNormal: 'Normal Creativity',
        creativityMax: 'Maximum Creativity',
      }
    };

    // Function to apply language to UI elements
    function applyLanguageToUI() {
      const langData = translations[currentLanguage] || translations['en'];
      messageInput.placeholder = langData.inputPlaceholder;
      sendBtn.innerText = langData.sendButtonText;

      updateCreativityButtonState();
    }

    // Funkcja aktualizująca stan wizualny i aria-label przycisku kreatywności
    function updateCreativityButtonState() {
        const langData = translations[currentLanguage] || translations['en'];
        if (currentTemperature === DEFAULT_TEMPERATURE) {
            creativityToggleBtn.classList.remove('active');
            creativityToggleBtn.setAttribute('aria-label', langData.creativityNormal);
        } else {
            creativityToggleBtn.classList.add('active');
            creativityToggleBtn.setAttribute('aria-label', langData.creativityMax);
        }
    }

    // Funkcja do obsługi kliknięć przycisków kopiowania (delegacja zdarzeń)
    function addCopyButtonListeners(containerElement) {
        const langData = translations[currentLanguage] || translations['en'];
        containerElement.addEventListener('click', async (event) => {
            const target = event.target.closest('.copy-button');
            if (target) {
                const codeContainer = target.closest('.code-container');
                if (codeContainer) {
                    const codeElement = codeContainer.querySelector('pre code');
                    if (codeElement) {
                        const codeText = codeElement.textContent;
                        try {
                            await navigator.clipboard.writeText(codeText);
                            target.innerHTML = `<i class="fas fa-check"></i> ${langData.copiedButtonText}`;
                            target.classList.add('copied');
                            setTimeout(() => {
                                target.innerHTML = '<i class="fas fa-copy"></i>';
                                target.classList.remove('copied');
                                target.setAttribute('aria-label', langData.copyButtonText);
                            }, 2000);
                        } catch (err) {
                            console.error('Failed to copy code: ', err);
                        }
                    }
                }
            }
        });
    }

    // NOWE: Funkcja do wywoływania wibracji
    function vibrateDevice(pattern) {
        // Sprawdź, czy API wibracji jest dostępne
        if (navigator.vibrate) {
            navigator.vibrate(pattern);
        } else {
            console.warn("API wibracji nie jest wspierane w tej przeglądarce.");
        }
    }


    // Function to detect and set language based on user's IP (approximate)
    async function detectAndSetLanguage() {
      try {
        const response = await fetch('http://ip-api.com/json/?fields=countryCode');
        const data = await response.json();

        if (data.status === 'success' && data.countryCode) {
          if (data.countryCode.toUpperCase() === 'PL') {
            currentLanguage = 'pl';
          } else {
            currentLanguage = 'en';
          }
        } else {
          console.warn('Could not detect language from IP. Status:', data.status, data.message);
        }
      } catch (error) {
        console.warn('Error detecting language from IP, defaulting to', currentLanguage, '. Error:', error);
      } finally {
        applyLanguageToUI();
      }
    }

    // Funkcja do dodawania numerów linii i przycisku kopiowania do bloku kodu
    function enhanceCodeBlock(preElement) {
        const langData = translations[currentLanguage] || translations['en'];
        const codeElement = preElement.querySelector('code');
        if (!codeElement) return null;

        const codeText = codeElement.textContent;
        const lines = codeText.split('\n');
        const lineCount = lines.length;

        const codeContainer = document.createElement('div');
        codeContainer.className = 'code-container';

        const lineNumbersDiv = document.createElement('div');
        lineNumbersDiv.className = 'line-numbers';

        for (let i = 1; i <= lineCount; i++) {
            const span = document.createElement('span');
            span.innerText = i;
            lineNumbersDiv.appendChild(span);
        }

        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.innerHTML = '<i class="fas fa-copy"></i>';

        codeContainer.appendChild(lineNumbersDiv);
        codeContainer.appendChild(preElement.cloneNode(true));
        codeContainer.appendChild(copyButton);

        return codeContainer;
    }


    // Function to append messages to the chat window
    function appendMessage(text, sender, isHtml = false) {
      const langData = translations[currentLanguage] || translations['en'];

      const wrapper = document.createElement('div');
      wrapper.className = sender === 'user'
        ? 'text-right'
        : 'text-left';

      const bubble = document.createElement('div');
      bubble.className = (sender === 'user'
        ? 'message-bubble user'
        : 'message-bubble bot');

      if (sender === 'bot') {
        let htmlContent = marked.parse(text);
        htmlContent = DOMPurify.sanitize(htmlContent, {
          USE_PROFILES: { html: true }
        });

        htmlContent = htmlContent.replace(/\b(tak)\b/gi, '<strong>$1</strong>');

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;

        const preElements = Array.from(tempDiv.querySelectorAll('pre'));
        const replacements = [];

        preElements.forEach(preElement => {
            const enhancedBlock = enhanceCodeBlock(preElement);
            if (enhancedBlock && preElement.parentNode) {
                 replacements.push({
                     parent: preElement.parentNode,
                     oldChild: preElement,
                     newChild: enhancedBlock
                 });
            } else if (!preElement.parentNode) {
                 console.warn("enhanceCodeBlock: Original pre element has no parent. Skipping enhancement.");
                 console.log("Pre Element:", preElement);
            }
        });

        replacements.forEach(replacement => {
             try {
                if (replacement.parent && replacement.parent.contains(replacement.oldChild)) {
                    replacement.parent.replaceChild(replacement.newChild, replacement.oldChild);
                } else {
                    console.error("enhanceCodeBlock: Parent node missing or does not contain the pre element just before replacement. Skipping replacement.");
                    console.log("Old Child:", replacement.oldChild);
                    console.log("Parent:", replacement.parent);
                }
             } catch (e) {
                 console.error("Error during replaceChild:", e);
                 console.log("Replacement attempt:", replacement);
             }
        });

        bubble.innerHTML = tempDiv.innerHTML;

        addCopyButtonListeners(bubble);


      } else {
        if (isHtml) {
             bubble.innerHTML = text;
        } else {
             bubble.innerText = text;
        }
      }

      wrapper.appendChild(bubble);
      chat.appendChild(wrapper);


      if (sender === 'bot') {
          appendSuggestedQuestions(wrapper, text);
      }


      chat.scrollTop = chat.scrollHeight;
      return bubble;
    }

    // Funkcja do dodawania sugerowanych pytań
    function appendSuggestedQuestions(messageWrapperElement, botResponseText) {
        const langData = translations[currentLanguage] || translations['en'];
        const suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'suggested-questions';

        const title = document.createElement('p');
        title.innerText = langData.suggestedQuestionsTitle;
        suggestionsDiv.appendChild(title);

        const suggestions = generateSimpleSuggestions(botResponseText);

        suggestions.forEach(suggestion => {
            const button = document.createElement('button');
            button.innerText = suggestion;
            button.addEventListener('click', () => {
                messageInput.value = suggestion;
                sendMessage(suggestion);
            });
            suggestionsDiv.appendChild(button);
        });

        messageWrapperElement.appendChild(suggestionsDiv);
    }

    // Prosta funkcja generująca sugerowane pytania
    function generateSimpleSuggestions(botResponseText) {
        const suggestions = [];
        if (botResponseText.toLowerCase().includes('javascript')) {
            suggestions.push('Podaj przykład kodu JavaScript.');
            suggestions.push('Jak działa hoisting w JS?');
        }
        if (botResponseText.toLowerCase().includes('python')) {
             suggestions.push('Pokaż prosty skrypt Python.');
             suggestions.push('Czym jest GIL w Pythonie?');
        }
         if (botResponseText.toLowerCase().includes('błąd')) {
             suggestions.push('Jak debugować ten błąd?');
         }
        if (suggestions.length === 0) {
             suggestions.push('Powiedz coś więcej.');
             suggestions.push('Co o tym myślisz?');
        }
        return suggestions.slice(0, 3);
    }


    // Function to add a temporary loading indicator (z animacją)
    function appendLoadingIndicator() {
      const langData = translations[currentLanguage] || translations['en'];
      const wrapper = document.createElement('div');
      wrapper.className = 'text-left';

      const bubble = document.createElement('div');
      bubble.innerText = langData.loadingText;
      bubble.className = 'inline-block bg-gray-200 text-gray-600 px-4 py-2 rounded-tr-lg rounded-br-lg rounded-bl-lg animate-pulse max-w-[80%] animate-typing';

      wrapper.appendChild(bubble);
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;
      loadingMessageElement = wrapper;
    }

    // Function to remove the loading indicator
    function removeLoadingIndicator() {
      if (loadingMessageElement && loadingMessageElement.parentNode) {
        loadingMessageElement.parentNode.removeChild(loadingMessageElement);
        loadingMessageElement = null;
      }
    }

    // Funkcja do zapisywania historii w Local Storage
    function saveHistory() {
        try {
            const historyToSave = conversationHistory.map(msg => {
                 if (msg.role === 'user' && msg.parts.some(part => part.inline_data)) {
                     const textPart = msg.parts.find(part => part.text);
                     return {
                         role: msg.role,
                         parts: textPart ? [textPart] : []
                     };
                 }
                 return msg;
            }).filter(msg => msg.parts.length > 0);

            localStorage.setItem(LOCAL_STORAGE_HISTORY_KEY, JSON.stringify(historyToSave));
        } catch (e) {
            console.error("Could not save history to Local Storage:", e);
        }
    }

    // Funkcja do ładowania historii z Local Storage
    function loadHistory() {
        try {
            const savedHistory = localStorage.getItem(LOCAL_STORAGE_HISTORY_KEY);
            if (savedHistory) {
                conversationHistory = JSON.parse(savedHistory);
                conversationHistory.forEach(msg => {
                    if (msg.role === 'user') {
                         if (msg.parts.length > 0 && msg.parts[0].text) {
                             appendMessage(msg.parts[0].text, 'user');
                         }
                    } else if (msg.role === 'model') {
                        appendMessage(msg.parts[0].text, 'bot');
                    }
                });
                 chat.scrollTop = chat.scrollHeight;
            }
        } catch (e) {
            console.error("Could not load history from Local Storage:", e);
             conversationHistory = [];
        }
    }


    // Function to start a new chat (z czyszczeniem Local Storage)
    function startNewChat() {
        conversationHistory = [];
        chat.innerHTML = '';
        saveHistory();
        messageInput.focus();
        imageInput.value = null;
        imagePreview.classList.add('hidden');
        imagePreview.src = '#';
    }

    // Usunięto funkcję playSound
    // function playSound(audioElement) { ... }


    // Funkcja do konwersji pliku obrazu na base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }


    // Function to handle sending messages to the Gemini API
    async function sendMessage(message) {
      const langData = translations[currentLanguage] || translations['en'];
      const imageFile = imageInput.files[0];

      if (!message.trim() && !imageFile) return;

      const currentUserTurnParts = [];

      if (message.trim()) {
        currentUserTurnParts.push({ text: message });
        appendMessage(message, 'user');
      }

      if (imageFile) {
        try {
          const base64Data = await fileToBase64(imageFile);
          currentUserTurnParts.push({
            inline_data: {
              mime_type: imageFile.type,
              data: base64Data
            }
          });
          const imgHtml = `<img src="data:${imageFile.type};base64,${base64Data}" alt="Wysłany obraz" class="inline-block max-w-[80%] max-h-[100px] rounded-lg my-2">`;
          appendMessage(imgHtml, 'user', true);

        } catch (e) {
          console.error("Error processing image:", e);
          appendMessage(`Błąd przetwarzania obrazu: ${e.message}`, 'bot');
          if (!message.trim()) {
            sendBtn.disabled = false;
            messageInput.disabled = false;
            newChatBtn.disabled = false;
            attachButton.disabled = false;
            messageInput.focus();
            return;
          }
          currentUserTurnParts = currentUserTurnParts.filter(part => !part.inline_data);
        } finally {
          imageInput.value = null;
          imagePreview.classList.add('hidden');
          imagePreview.src = '#';
        }
      }

      if (currentUserTurnParts.length === 0) {
          sendBtn.disabled = false;
          messageInput.disabled = false;
          newChatBtn.disabled = false;
          attachButton.disabled = false;
          messageInput.focus();
          return;
      }


      messageInput.value = '';
      sendBtn.disabled = true;
      messageInput.disabled = true;
      newChatBtn.disabled = true;
      attachButton.disabled = true;
      appendLoadingIndicator();
      vibrateDevice([50]); // NOWE: Wibracja przy wysyłaniu


      try {
        const modelToUse = 'gemini-1.5-flash';

        const temperature = currentTemperature;

        const systemInstructionParts = [{ text: langData.systemMessage }];

        const apiContents = [
            ...conversationHistory,
            { role: 'user', parts: currentUserTurnParts }
        ];

        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: apiContents,
            system_instruction: { parts: systemInstructionParts },
            generationConfig: { temperature: temperature }
          })
        });

        if (!res.ok) {
          const errorData = await res.json();
          let displayErrorMessage = langData.errorApi;

          if (errorData.error && errorData.error.message) {
            displayErrorMessage += `: ${errorData.error.message}`;
          } else {
            if (res.status === 400) {
               displayErrorMessage += `: ${langData.errorApiRequest}`;
            } else if (res.status === 401) {
               displayErrorMessage += `: ${langData.errorApiAuth}`;
            } else if (res.status === 429) {
               displayErrorMessage += `: ${langData.errorApiQuota}`;
            } else if (res.status >= 500) {
               displayErrorMessage = langData.errorApiServer(res.status);
            } else {
               displayErrorMessage += ` (Kod statusu: ${res.status})`;
            }
          }
          throw new Error(displayErrorMessage);
        }

        const data = await res.json();
        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text;

        removeLoadingIndicator();

        if (!reply) {
            console.warn("Gemini returned no text reply:", data);
            appendMessage(langData.errorNoReply, 'bot');
            const userHistoryTurn = { role: 'user', parts: currentUserTurnParts.filter(part => part.text) };
            if (userHistoryTurn.parts.length > 0) conversationHistory.push(userHistoryTurn);
            conversationHistory.push({ role: 'model', parts: [{ text: langData.errorNoReply }] });
            saveHistory();
        } else {
            const userHistoryTurn = { role: 'user', parts: currentUserTurnParts.filter(part => part.text) };
            if (userHistoryTurn.parts.length > 0) conversationHistory.push(userHistoryTurn);
            conversationHistory.push({ role: 'model', parts: [{ text: reply }] });

            appendMessage(reply, 'bot');
            vibrateDevice([100]); // NOWE: Wibracja przy odbieraniu
            saveHistory();
        }

        if (conversationHistory.length > HISTORY_LIMIT) {
            conversationHistory = conversationHistory.slice(conversationHistory.length - HISTORY_LIMIT);
        }


      } catch (err) {
        removeLoadingIndicator();
        console.error('Wystąpił błąd komunikacji z Gemini API:', err);
        appendMessage(`${langData.errorApi}: ${err.message || langData.errorGeneric}`, 'bot');
        const userHistoryTurn = { role: 'user', parts: currentUserTurnParts.filter(part => part.text) };
        if (userHistoryTurn.parts.length > 0) conversationHistory.push(userHistoryTurn);
        conversationHistory.push({ role: 'model', parts: [{ text: `${langData.errorApi}: ${err.message || langData.errorGeneric}` }] });
        saveHistory();

        if (conversationHistory.length > HISTORY_LIMIT) {
            conversationHistory = conversationHistory.slice(conversationHistory.length - HISTORY_LIMIT);
        }


      } finally {
        sendBtn.disabled = false;
        messageInput.disabled = false;
        newChatBtn.disabled = false;
        attachButton.disabled = false;
        messageInput.focus();
      }
    }

    // Nasłuchiwacz zdarzeń dla przycisku przełączającego kreatywność
    creativityToggleBtn.addEventListener('click', () => {
        if (currentTemperature === DEFAULT_TEMPERATURE) {
            currentTemperature = MAX_TEMPERATURE;
        } else {
            currentTemperature = DEFAULT_TEMPERATURE;
        }
        updateCreativityButtonState();
        console.log("Kreatywność ustawiona na:", currentTemperature);
    });


    // Nasłuchiwacz zdarzeń dla pola wyboru obrazu
    imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        } else {
            imagePreview.classList.add('hidden');
            imagePreview.src = '#';
        }
    });

    // Nasłuchiwacz zdarzeń dla przycisku spinacza
    attachButton.addEventListener('click', () => {
        imageInput.click();
    });


    // Event listeners
    sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
    messageInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        sendMessage(messageInput.value);
      }
    });

    // Nasłuchiwacz zdarzeń dla przycisku Nowy czat
    newChatBtn.addEventListener('click', startNewChat);


    // Set focus on the input field after page load
    messageInput.focus();

    // Detect and set language and load history after page load
    window.onload = async function () {
        await detectAndSetLanguage();
        loadHistory();
        updateCreativityButtonState();
    };

    // Dodaj nasłuchiwacz zdarzeń kliknięcia do elementu chat dla delegacji przycisków kopiowania
    addCopyButtonListeners(chat);

  </script>
</body>
</html>
