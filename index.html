<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jurek36AI ChatBot 2.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

  <style>
    /* Custom scrollbar for better appearance */
    #chat::-webkit-scrollbar,
    #chat-history-list::-webkit-scrollbar { /* Dodano scrollbar dla listy historii */
      width: 8px;
    }
    #chat::-webkit-scrollbar-track,
    #chat-history-list::-webkit-scrollbar-track { /* Dodano scrollbar dla listy historii */
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    #chat::-webkit-scrollbar-thumb,
    #chat-history-list::-webkit-scrollbar-thumb { /* Dodano scrollbar dla listy historii */
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
    }
    #chat::-webkit-scrollbar-thumb:hover,
    #chat-history-list::-webkit-scrollbar-thumb:hover { /* Dodano scrollbar dla listy historii */
      background: rgba(255, 255, 255, 0.5);
    }

    /* Animated Gradient Background - Ciemny motyw */
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: linear-gradient(-45deg, #1a202c, #2d3748, #2a4365, #2b6cb0);
      background-size: 400% 400%;
      animation: gradientAnimation 15s ease infinite;
      color: #e2e8f0; /* Jasny kolor tekstu dla ciemnego tła */
    }

    @keyframes gradientAnimation {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    /* Main layout container */
    .main-container {
        display: flex;
        min-height: 100vh;
        width: 100%;
        overflow: hidden; /* Zapobiega przewijaniu przy wysuniętym panelu */
    }

    /* Sidebar styling */
    .sidebar {
        width: 250px; /* Szerokość panelu bocznego */
        background-color: rgba(30, 41, 59, 0.95);
        color: #e2e8f0;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        transform: translateX(-100%); /* Domyślnie ukryty poza ekranem */
        transition: transform 0.3s ease-in-out; /* Animacja wysuwania */
        position: fixed; /* Panel boczny jest stały */
        top: 0;
        left: 0;
        bottom: 0;
        z-index: 20; /* Wyższa warstwa niż główna treść */
        box-shadow: 2px 0 5px rgba(0,0,0,0.5);
    }

    .sidebar.open {
        transform: translateX(0); /* Wysunięty panel */
    }

    /* Overlay when sidebar is open */
    .overlay {
        display: none; /* Domyślnie ukryty */
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10; /* Pomiędzy panelem a główną treścią */
    }

    .overlay.visible {
        display: block;
    }

    /* Chat container styling */
    .chat-container-wrapper {
        flex-grow: 1; /* Zajmuje pozostałą przestrzeń */
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 1rem;
        width: 100%;
        transition: margin-left 0.3s ease-in-out; /* Przesunięcie głównej treści przy wysuwaniu panelu */
    }

     /* Przesunięcie głównej treści, gdy panel jest otwarty (opcjonalne, jeśli panel nie jest fixed) */
    /* .main-container.sidebar-open .chat-container-wrapper {
        margin-left: 250px;
    } */


    .chat-container {
        width: 100%;
        max-width: 500px;
        background-color: rgba(30, 41, 59, 0.9);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
        border-radius: 1rem;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 90vh;
        max-height: 700px;
    }

    /* Header styling */
    .chat-header {
      background: rgba(45, 55, 72, 0.8);
      color: white;
      padding: 1.5rem;
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1.rem;
      position: relative;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 0.75rem;
    }

    /* Header title styling */
    .chat-header h1 {
        margin: 0;
        text-align: left;
        color: #e2e8f0;
        flex-grow: 1; /* Pozwala tytułowi zająć dostępną przestrzeń */
    }

    /* Styl dla logo w nagłówku (element img) */
    .header-logo {
        height: 5rem;
        width: auto;
        border-radius: 0.25rem;
    }

    /* Styl dla przycisku otwierającego panel boczny */
    .sidebar-toggle-button {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0 0.5rem;
        transition: color 0.2s ease-in-out;
    }

    .sidebar-toggle-button:hover {
        color: #a0aec0;
    }


    /* Styl dla przycisku przełączania kreatywności (ikona) */
    .creativity-toggle-button {
        background-color: rgba(71, 85, 105, 0.8); /* Szare tło (domyślne) */
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 0.5rem;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.2s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .creativity-toggle-button:hover {
        background-color: rgba(45, 55, 72, 0.8);
    }

    /* Styl dla aktywnego przycisku kreatywności (niebieski) */
    .creativity-toggle-button.active {
        background-color: rgba(66, 153, 225, 0.9); /* blue-400 z przezroczystością */
    }

    .creativity-toggle-button.active:hover {
         background-color: rgba(49, 130, 189, 0.9); /* blue-500 z przezroczystością */
    }

    /* Ukryj standardowe pole input file */
    #image-input {
        display: none;
    }

    /* Styl dla podglądu obrazu */
    .image-preview {
        max-width: 100%;
        max-height: 100px;
        object-fit: contain;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    /* Main chat area styling */
    .chat-main {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        space-y: 1rem;
        background-color: rgba(30, 41, 59, 0.7);
    }

    /* Footer styling */
    .chat-footer {
        padding: 1rem;
        background-color: rgba(45, 55, 72, 0.9);
        border-top: 1px solid #4a5568;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Input styling */
    .chat-input {
        flex: 1;
        padding: 0.5rem 1rem;
        border: 1px solid #4a5568;
        background-color: rgba(74, 85, 104, 0.5);
        color: #e2e8f0;
        border-radius: 0.5rem;
        outline: none;
        transition: border-color 0.2s ease-in-out, ring-color 0.2s ease-in-out;
        min-width: 0;
    }
    .chat-input::placeholder {
      color: #a0aec0;
    }
    .chat-input:focus {
        border-color: #63b3ed;
        ring: 2px;
        ring-color: #90cdf4;
        background-color: rgba(74, 85, 104, 0.7);
    }
    .chat-input:disabled {
        background-color: #2d3748;
        cursor: not-allowed;
        color: #a0aec0;
    }

    /* Styl dla przycisku spinacza (załączania plików) */
    .attach-button {
        background: none;
        border: none;
        color: #90cdf4;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: color 0.2s ease-in-out;
    }

    .attach-button:hover {
        color: #63b3ed;
    }

    /* Send button styling */
    .chat-send-button {
        padding: 0.5rem 1rem;
        background-color: #4299e1;
        color: white;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease-in-out;
        border: none;
        cursor: pointer;
    }
    .chat-send-button:hover {
        background-color: #3182ce;
    }
    .chat-send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Message bubble styling */
    .message-bubble {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      max-width: 80%;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message-bubble.user {
      background-color: rgba(66, 153, 225, 0.9);
      color: white;
      border-top-right-radius: 0;
    }

    .message-bubble.bot {
      background-color: rgba(74, 85, 104, 0.9);
      color: #e2e8f0;
      border-top-left-radius: 0;
    }

    /* Style dla bloków kodu z numerami linii i przyciskiem kopiowania */
    .code-container {
        display: flex;
        position: relative;
        border-radius: 0.5rem;
        overflow: hidden;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
        background-color: #2d3748;
    }

    .line-numbers {
        flex-shrink: 0;
        width: 2.5rem;
        padding: 0.75rem 0.5rem;
        background-color: rgba(45, 55, 72, 0.8);
        color: #a0aec0;
        text-align: right;
        font-family: 'Fira Code', 'Cascadia Code', 'Source Code Pro', monospace;
        font-size: 0.8rem;
        line-height: 1.4;
        user-select: none;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        border-right: 1px solid rgba(71, 85, 105, 0.8);
    }

    .line-numbers span {
        height: 1.4em;
    }

    .code-container pre {
      flex-grow: 1;
      padding: 0.75rem;
      margin: 0;
      overflow-x: auto;
    }

    .code-container pre code {
      font-family: 'Fira Code', 'Cascadia Code', 'Source Code Pro', monospace;
      font-size: 0.9rem;
      line-height: 1.4;
      display: block;
    }

    .copy-button {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out;
        z-index: 1;
    }

    .code-container:hover .copy-button {
        opacity: 1;
    }

    .copy-button:hover {
        background-color: rgba(255, 255, 255, 0.4);
    }

    .copy-button.copied {
        background-color: #48bb78;
        color: white;
    }

    /* Style dla sugerowanych pytań */
    .suggested-questions {
        margin-top: 1rem;
        padding-top: 0.5rem;
        border-top: 1px solid #4a5568;
        font-size: 0.9rem;
        color: #a0aec0;
    }

    .suggested-questions p {
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #e2e8f0;
    }

    .suggested-questions button {
        background-color: rgba(66, 153, 225, 0.1);
        color: #90cdf4;
        border: 1px solid rgba(66, 153, 225, 0.3);
        border-radius: 0.5rem;
        padding: 0.25rem 0.75rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }

    .suggested-questions button:hover {
        background-color: rgba(66, 153, 225, 0.2);
    }

    /* Animacja wskaźnika ładowania */
    .animate-typing::after {
      content: '...';
      animation: typing 1s infinite steps(1);
    }

    @keyframes typing {
      0% { content: '.'; }
      33% { content: '..'; }
      66% { content: '...'; }
      100% { content: '.'; }
    }

    /* Styl dla listy historii czatów w panelu bocznym */
    .chat-history-list {
        flex-grow: 1; /* Zajmuje dostępną przestrzeń */
        margin-top: 1rem;
        overflow-y: auto; /* Włącz przewijanie, jeśli lista jest długa */
        padding-right: 0.5rem; /* Miejsce na scrollbar */
    }

    /* Styl dla pojedynczego elementu historii czatu */
    .chat-history-item {
        background-color: rgba(71, 85, 105, 0.5);
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
        font-size: 0.9rem;
        overflow: hidden; /* Ukryj przepełniony tekst */
        text-overflow: ellipsis; /* Dodaj wielokropek */
        white-space: nowrap; /* Zapobiegaj zawijaniu tekstu */
    }

    .chat-history-item:hover {
        background-color: rgba(71, 85, 105, 0.8);
    }

     .chat-history-item.active {
        background-color: rgba(66, 153, 225, 0.7); /* Podświetlenie aktywnego czatu */
     }

     /* Styl dla przycisku "Nowy Czat" w panelu bocznym */
     .sidebar-new-chat-button {
        background-color: rgba(66, 153, 225, 0.9);
        border: none;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        padding: 0.75rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease-in-out;
        text-align: center;
        margin-bottom: 1rem; /* Odstęp od listy */
     }

     .sidebar-new-chat-button:hover {
        background-color: rgba(49, 130, 189, 0.9);
     }


     /* Styl dla kontenerów reklamowych */
     .ad-container {
         width: 100%;
         text-align: center; /* Wyśrodkowanie reklamy */
         margin: 1rem 0; /* Odstęp od innych elementów */
         /* Możesz dodać więcej stylów, np. wysokość minimalną, obramowanie */
     }


     /* Media query for smaller screens */
     @media (max-width: 600px) {
         .sidebar {
             width: 100%; /* Na małych ekranach panel zajmuje całą szerokość */
         }
         /* .main-container.sidebar-open .chat-container-wrapper {
            margin-left: 0; // Brak przesunięcia głównej treści
         } */
     }


  </style>
</head>
<body>
  <div class="main-container" id="main-container">
    <div class="sidebar" id="sidebar">
        <button class="sidebar-new-chat-button" id="sidebar-new-chat-btn">
            <i class="fas fa-plus"></i> Nowy Czat
        </button>
        <div class="chat-history-list" id="chat-history-list">
            </div>
        </div>

    <div class="overlay" id="overlay"></div>

    <div class="chat-container-wrapper">
      <div class="chat-container">
        <header class="chat-header">
          <button class="sidebar-toggle-button" id="sidebar-toggle-btn" aria-label="Otwórz panel boczny">
              <i class="fas fa-bars"></i>
          </button>

          <img src="https://i.postimg.cc/rFgBD37y/file-00000000eef061f4966205833b4b6822-removebg-preview.png" alt="Jurek36AI Chatbot Logo" class="header-logo">
          <h1>Jurek36AI ChatBot 2.0</h1>
          <select id="language-select" class="bg-gray-700 text-white text-sm rounded-lg p-1 ml-auto">
              <option value="pl">Polski</option>
              <option value="en">English</option>
          </select>
          <button id="creativity-toggle-btn" class="creativity-toggle-button" aria-label="Przełącz kreatywność">
               <i class="fas fa-cog"></i>
          </button>
        </header>

        <input type="file" id="image-input" accept="image/*">
       <img id="image-preview" class="image-preview hidden" src="#" alt="Podgląd obrazu">

      <main id="chat" class="chat-main">
        </main>
      <footer class="chat-footer">
        <button id="attach-button" class="attach-button" aria-label="Załącz plik">
             <i class="fas fa-paperclip"></i>
        </button>
        <input id="message" type="text" placeholder="Napisz wiadomość..."
               class="chat-input" />

        <button id="send" class="chat-send-button">
          Wyślij
        </button>
      </footer>
      </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <script>
    // !!! === BARDZO WAŻNE OSTRZEŻENIA BEZPIECZEŃSTWA === !!!
    // PONIŻEJ MUSISZ WPROWADZIĆ SWÓJ KLUCZ API GOOGLE GEMINI.
    // UMIESZCZANIE KLUCZA API BEZPOŚREDNIO W KODZIE KLIENTA (FRONTENDU)
    // JEST BARDZO NIEBEZPIECZNE! KAZDY, KTO OTWORZY KONSOLĘ PRZEGLĄDARKĘ,
    // BĘDZIE MÓGŁ ZOBACZYĆ I UKRAŚĆ TWÓJ KLUCZ.
    // ZALECAM UŻYCIE TEGO ROZWIĄZANIA TYLKO DO TESTÓW/ROWOJU LOKALNEGO.
    // DLA APLIKACJI PRODUKCYJNYCH ZAWSZE UŻYWAJ BEZPIECZNEGO BACKENDU,
    // KTÓRY BĘDZIE PRZECHOWYWAŁ KLUCZ API I POŚREDNICZYŁ W KOMUNIKACJI.
    const GEMINI_API_KEY = 'AIzaSyChSd5TnsmPwLYZAQclq_al2WC4KVULWNg'; // <--- TUTAJ WPROWADŹ SWÓJ KLUCZ API GOOGLE GEMINI
    // Adres URL webhooka Discorda
    const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1371742303135207444/Z8u_qd8gzRufhFEbEs_5jzVwI7TkKqXk6rsEYBpn6NPqhEMXp9d5cc2XMirHGyEwDIHs';

    const chat = document.getElementById('chat');
    const messageInput = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    const imageInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview');
    const attachButton = document.getElementById('attach-button');
    const creativityToggleBtn = document.getElementById('creativity-toggle-btn');
    // Elementy panelu bocznego
    const sidebar = document.getElementById('sidebar');
    const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
    const overlay = document.getElementById('overlay');
    const sidebarNewChatBtn = document.getElementById('sidebar-new-chat-btn'); // Przycisk "Nowy Czat" w panelu
    const chatHistoryList = document.getElementById('chat-history-list'); // Lista historii czatów
    const languageSelect = document.getElementById('language-select'); // Element do wyboru języka

    let loadingMessageElement = null;
    let currentLanguage = 'pl'; // Domyślny język
    // *** ZMIENNA DO PRZECHOWYWANIA HISTORII ROZMOWY AKTUALNEGO CZATU ***
    let conversationHistory = [];
    // *** Limit historii rozmowy (liczba tur: użytkownik + bot = 2 wiadomości) ***
    const HISTORY_LIMIT = 20;
    // Klucz dla aktualnej historii czatu w Local Storage
    const LOCAL_STORAGE_CURRENT_HISTORY_KEY = 'jurek36ai_current_chat_history';
    // Klucz dla listy wszystkich zapisanych czatów w Local Storage
    const LOCAL_STORAGE_CHAT_LIST_KEY = 'jurek36ai_chat_list';
    // Klucz dla zapisanego języka w Local Storage
    const LOCAL_STORAGE_LANGUAGE_KEY = 'jurek36ai_language';


    // Wartości kreatywności i aktualny stan
    const DEFAULT_TEMPERATURE = 0.6;
    const MAX_TEMPERATURE = 1.0;
    let currentTemperature = DEFAULT_TEMPERATURE;

    // Zmienna do przechowywania ID aktualnie załadowanego czatu
    let currentChatId = null;

    // Marked.js configuration
    marked.setOptions({
      breaks: true,
      gfm: true,
      highlight: function(code, lang) {
        const language = highlight.getLanguage(lang) ? lang : 'plaintext';
        try {
          return highlight.highlight(code, { language }).value;
        } catch (e) {
          console.error("Highlighting error:", e);
          return code;
        }
      },
    });

    // Dictionary of translations
    const translations = {
      'pl': {
        systemMessage: 'Jesteś pomocnym asystentem, który mówi po polsku. Gdy odpowiadasz, możesz używać formatowania Markdown takiego jak **pogrubienie**, *kursywa*, `kod inline` lub bloki kodu:\n```javascript\nconsole.log("Witaj!");\n```\n. Twój język jest polski.',
        inputPlaceholder: 'Napisz wiadomość...',
        sendButtonText: 'Wyślij',
        loadingText: 'Jurek36AI 2.0 pisze',
        errorGeneric: 'Wystąpił nieoczekiwany błąd komunikacji.',
        errorApi: 'Błąd API Gemini.',
        errorApiRequest: 'Błąd żądania (400). Upewnij się, że Twój klucz API i treść żądania są poprawne.',
        errorApiAuth: 'Błąd autoryzacji (401). Sprawdź swój klucz API Gemini.',
        errorApiQuota: 'Przekroczono limit zapytań (429). Spróbuj ponownie później.',
        errorApiServer: (status) => `Błąd serwera Gemini (HTTP ${status}). Spróbuj ponownie później.`,
        errorNoReply: 'Nie otrzymano odpowiedzi tekstowej od bota Gemini.',
        copyButtonText: 'Kopiuj',
        copiedButtonText: 'Skopiowano!',
        suggestedQuestionsTitle: 'Możesz zapytać:',
        creativityNormal: 'Normalna Kreatywność',
        creativityMax: 'Maksymalna Kreatywność',
        newChatButtonText: 'Nowy Czat', // Tłumaczenie dla przycisku w panelu
        defaultChatTitle: 'Nowa rozmowa', // Domyślny tytuł czatu
        sidebarTitle: 'Historia Czatów', // Tytuł panelu bocznego
        attachButtonLabel: 'Załącz plik', // Etykieta przycisku załączania
        openSidebarLabel: 'Otwórz panel boczny', // Etykieta przycisku otwierania panelu
        creativityToggleLabel: 'Przełącz kreatywność', // Etykieta przycisku kreatywności
        sentImageAlt: 'Wysłany obraz', // Alt text dla wysłanego obrazu
        imageProcessingError: 'Błąd przetwarzania obrazu', // Komunikat o błędzie przetwarzania obrazu
      },
      'en': {
        systemMessage: 'You are a helpful assistant who speaks English. When responding, you can use Markdown formatting like **bold**, *italics*, `inline code` or code blocks:\n```javascript\nconsole.log("Hello!");\n```\n. Your language is English.',
        inputPlaceholder: 'Write a message...',
        sendButtonText: 'Send',
        loadingText: 'Jurek36AI 2.0 is typing',
        errorGeneric: 'An unexpected communication error occurred.',
        errorApi: 'Gemini API Error.',
        errorApiRequest: 'Bad request (400). Ensure your API key and request body are correct.',
        errorApiAuth: 'Authorization error (401). Check your Gemini API key.',
        errorApiQuota: 'Quota exceeded (429). Try again later.',
        errorApiServer: (status) => `Gemini server error (HTTP ${status}). Please try again later.`,
        errorNoReply: 'No text reply received from Gemini bot.',
        copyButtonText: 'Copy',
        copiedButtonText: 'Copied!',
        suggestedQuestionsTitle: 'You can ask:',
        creativityNormal: 'Normal Creativity',
        creativityMax: 'Maximum Creativity',
        newChatButtonText: 'New Chat', // Tłumaczenie dla przycisku w panelu
        defaultChatTitle: 'New conversation', // Domyślny tytuł czatu
        sidebarTitle: 'Chat History', // Tytuł panelu bocznego
        attachButtonLabel: 'Attach file', // Etykieta przycisku załączania
        openSidebarLabel: 'Open sidebar', // Etykieta przycisku otwierania panelu
        creativityToggleLabel: 'Toggle creativity', // Etykieta przycisku kreatywności
        sentImageAlt: 'Sent image', // Alt text dla wysłanego obrazu
        imageProcessingError: 'Image processing error', // Komunikat o błędzie przetwarzania obrazu
      }
    };

    // Function to apply language to UI elements
    function applyLanguageToUI() {
      const langData = translations[currentLanguage] || translations['en'];
      messageInput.placeholder = langData.inputPlaceholder;
      sendBtn.innerText = langData.sendButtonText;
      sidebarNewChatBtn.innerHTML = `<i class="fas fa-plus"></i> ${langData.newChatButtonText}`; // Ustaw tekst dla przycisku w panelu
      // Aktualizacja etykiet aria-label
      sidebarToggleBtn.setAttribute('aria-label', langData.openSidebarLabel);
      attachButton.setAttribute('aria-label', langData.attachButtonLabel);

      // Aktualizacja tekstu w panelu bocznym (jeśli istnieje tytuł)
      const sidebarTitleElement = sidebar.querySelector('h2'); // Zakładając, że masz h2 w sidebarze
      if (sidebarTitleElement) {
          sidebarTitleElement.innerText = langData.sidebarTitle;
      }


      updateCreativityButtonState();
      renderChatList(); // Odśwież listę czatów po zmianie języka
      // Opcjonalnie: odśwież wszystkie wiadomości w czacie, aby przetłumaczyć sugerowane pytania
      // To może być kosztowne dla długich czatów, można zrezygnować lub zaimplementować sprytniej
      // refreshChatMessages();
    }

    // Funkcja aktualizująca stan wizualny i aria-label przycisku kreatywności
    function updateCreativityButtonState() {
        const langData = translations[currentLanguage] || translations['en'];
        if (currentTemperature === DEFAULT_TEMPERATURE) {
            creativityToggleBtn.classList.remove('active');
            creativityToggleBtn.setAttribute('aria-label', langData.creativityNormal);
        } else {
            creativityToggleBtn.classList.add('active');
            creativityToggleBtn.setAttribute('aria-label', langData.creativityMax);
        }
    }

    // Funkcja do obsługi kliknięć przycisków kopiowania (delegacja zdarzeń)
    function addCopyButtonListeners(containerElement) {
        const langData = translations[currentLanguage] || translations['en'];
        containerElement.addEventListener('click', async (event) => {
            const target = event.target.closest('.copy-button');
            if (target) {
                const codeContainer = target.closest('.code-container');
                if (codeContainer) {
                    const codeElement = codeContainer.querySelector('pre code');
                    if (codeElement) {
                        const codeText = codeElement.textContent;
                        try {
                            await navigator.clipboard.writeText(codeText);
                            target.innerHTML = `<i class="fas fa-check"></i> ${langData.copiedButtonText}`;
                            target.classList.add('copied');
                            setTimeout(() => {
                                target.innerHTML = '<i class="fas fa-copy"></i>';
                                target.classList.remove('copied');
                                target.setAttribute('aria-label', langData.copyButtonText);
                            }, 2000);
                        } catch (err) {
                            console.error('Failed to copy code: ', err);
                        }
                    }
                }
            }
        });
    }

    // Funkcja do wywoływania wibracji
    function vibrateDevice(pattern) {
        // Sprawdź, czy API wibracji jest wspierane
        if (navigator.vibrate) {
            navigator.vibrate(pattern);
        } else {
            console.warn("API wibracji nie jest wspierane w tej przeglądarce.");
        }
    }

    // Function to detect and set language based on user's IP (approximate)
    async function detectAndSetLanguage() {
      try {
        const savedLanguage = localStorage.getItem(LOCAL_STORAGE_LANGUAGE_KEY);
        if (savedLanguage) {
            currentLanguage = savedLanguage;
        } else {
            const response = await fetch('http://ip-api.com/json/?fields=countryCode');
            const data = await response.json();

            if (data.status === 'success' && data.countryCode) {
              if (data.countryCode.toUpperCase() === 'PL') {
                currentLanguage = 'pl';
              } else {
                currentLanguage = 'en';
              }
            } else {
              console.warn('Could not detect language from IP. Status:', data.status, data.message);
            }
        }
      } catch (error) {
        console.warn('Error detecting language from IP, defaulting to', currentLanguage, '. Error:', error);
      } finally {
        // Ustaw wartość w selektorze języka
        languageSelect.value = currentLanguage;
        applyLanguageToUI();
      }
    }

    // Funkcja do dodawania numerów linii i przycisku kopiowania do bloku kodu
    function enhanceCodeBlock(preElement) {
        const langData = translations[currentLanguage] || translations['en'];
        const codeElement = preElement.querySelector('code');
        if (!codeElement) return null;

        const codeText = codeElement.textContent;
        const lines = codeText.split('\n');
        const lineCount = lines.length;

        const codeContainer = document.createElement('div');
        codeContainer.className = 'code-container';

        const lineNumbersDiv = document.createElement('div');
        lineNumbersDiv.className = 'line-numbers';

        for (let i = 1; i <= lineCount; i++) {
            const span = document.createElement('span');
            span.innerText = i;
            lineNumbersDiv.appendChild(span);
        }

        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
        copyButton.setAttribute('aria-label', langData.copyButtonText);


        codeContainer.appendChild(lineNumbersDiv);
        codeContainer.appendChild(preElement.cloneNode(true));
        codeContainer.appendChild(copyButton);

        return codeContainer;
    }

    // Function to append messages to the chat window
    function appendMessage(text, sender, isHtml = false) {
      const langData = translations[currentLanguage] || translations['en'];

      const wrapper = document.createElement('div');
      wrapper.className = sender === 'user'
        ? 'text-right'
        : 'text-left';

      const bubble = document.createElement('div');
      bubble.className = (sender === 'user'
        ? 'message-bubble user'
        : 'message-bubble bot');

      if (sender === 'bot') {
        let htmlContent = marked.parse(text);
        htmlContent = DOMPurify.sanitize(htmlContent, {
          USE_PROFILES: { html: true }
        });

        htmlContent = htmlContent.replace(/\b(tak)\b/gi, '<strong>$1</strong>');

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;

        const preElements = Array.from(tempDiv.querySelectorAll('pre'));
        const replacements = [];

        preElements.forEach(preElement => {
            const enhancedBlock = enhanceCodeBlock(preElement);
            if (enhancedBlock && preElement.parentNode) {
                 replacements.push({
                     parent: preElement.parentNode,
                     oldChild: preElement,
                     newChild: enhancedBlock
                 });
            } else if (!preElement.parentNode) {
                 console.warn("enhanceCodeBlock: Original pre element has no parent. Skipping enhancement.");
                 console.log("Pre Element:", preElement);
            }
        });

        replacements.forEach(replacement => {
             try {
                if (replacement.parent && replacement.parent.contains(replacement.oldChild)) {
                    replacement.parent.replaceChild(replacement.newChild, replacement.oldChild);
                } else {
                    console.error("enhanceCodeBlock: Parent node missing or does not contain the pre element just before replacement. Skipping replacement.");
                    console.log("Old Child:", replacement.oldChild);
                    console.log("Parent:", replacement.parent);
                }
             } catch (e) {
                 console.error("Error during replaceChild:", e);
                 console.log("Replacement attempt:", replacement);
             }
        });

        bubble.innerHTML = tempDiv.innerHTML;

        addCopyButtonListeners(bubble);

      } else {
        if (isHtml) {
             bubble.innerHTML = text;
        } else {
             bubble.innerText = text;
        }
      }

      wrapper.appendChild(bubble);
      chat.appendChild(wrapper);

      // Sugerowane pytania dodawane są tylko do wiadomości bota
      if (sender === 'bot') {
          appendSuggestedQuestions(wrapper, text);
      }

      chat.scrollTop = chat.scrollHeight;
      return bubble;
    }

    // Funkcja do dodawania sugerowanych pytań
    function appendSuggestedQuestions(messageWrapperElement, botResponseText) {
        const langData = translations[currentLanguage] || translations['en'];
        const suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'suggested-questions';

        const title = document.createElement('p');
        title.innerText = langData.suggestedQuestionsTitle;
        suggestionsDiv.appendChild(title);

        const suggestions = generateSimpleSuggestions(botResponseText);

        suggestions.forEach(suggestion => {
            const button = document.createElement('button');
            button.innerText = suggestion;
            button.addEventListener('click', () => {
                messageInput.value = suggestion;
                sendMessage(suggestion);
            });
            suggestionsDiv.appendChild(button);
        });

        messageWrapperElement.appendChild(suggestionsDiv);
    }

    // Prosta funkcja generująca sugerowane pytania (można rozbudować)
    function generateSimpleSuggestions(botResponseText) {
        const suggestions = [];
        const langData = translations[currentLanguage] || translations['en'];

        // Przykładowe sugestie zależne od języka i treści odpowiedzi bota
        if (currentLanguage === 'pl') {
            if (botResponseText.toLowerCase().includes('javascript')) {
                suggestions.push('Podaj przykład kodu JavaScript.');
                suggestions.push('Jak działa hoisting w JS?');
            }
            if (botResponseText.toLowerCase().includes('python')) {
                 suggestions.push('Pokaż prosty skrypt Python.');
                 suggestions.push('Czym jest GIL w Pythonie?');
            }
             if (botResponseText.toLowerCase().includes('błąd')) {
                 suggestions.push('Jak debugować ten błąd?');
             }
            // Domyślne sugestie, jeśli brak specyficznych
            if (suggestions.length === 0) {
                 suggestions.push('Powiedz coś więcej.');
                 suggestions.push('Co o tym myślisz?');
            }
        } else { // English
             if (botResponseText.toLowerCase().includes('javascript')) {
                 suggestions.push('Provide a JavaScript code example.');
                 suggestions.push('How does hoisting work in JS?');
             }
             if (botResponseText.toLowerCase().includes('python')) {
                  suggestions.push('Show a simple Python script.');
                  suggestions.push('What is GIL in Python?');
             }
              if (botResponseText.toLowerCase().includes('error')) {
                  suggestions.push('How to debug this error?');
              }
             // Default suggestions if no specific ones
             if (suggestions.length === 0) {
                  suggestions.push('Tell me more.');
                  suggestions.push('What do you think about this?');
             }
        }

        return suggestions.slice(0, 3); // Zwróć maksymalnie 3 sugestie
    }

    // Function to add a temporary loading indicator (z animacją)
    function appendLoadingIndicator() {
      const langData = translations[currentLanguage] || translations['en'];
      const wrapper = document.createElement('div');
      wrapper.className = 'text-left';

      const bubble = document.createElement('div');
      bubble.innerText = langData.loadingText;
      bubble.className = 'inline-block bg-gray-200 text-gray-600 px-4 py-2 rounded-tr-lg rounded-br-lg rounded-bl-lg animate-pulse max-w-[80%] animate-typing';

      wrapper.appendChild(bubble);
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;
      loadingMessageElement = wrapper;
    }

    // Function to remove the loading indicator
    function removeLoadingIndicator() {
      if (loadingMessageElement && loadingMessageElement.parentNode) {
        loadingMessageElement.parentNode.removeChild(loadingMessageElement);
        loadingMessageElement = null;
      }
    }

    // Funkcja do generowania unikalnego ID dla czatu
    function generateChatId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Funkcja do zapisywania aktualnej historii w Local Storage
    function saveCurrentHistory() {
        try {
            if (!currentChatId && conversationHistory.length > 0) {
                // Jeśli to nowa rozmowa i coś zostało napisane, nadaj jej ID
                currentChatId = generateChatId();
                const langData = translations[currentLanguage] || translations['en'];
                const chatTitle = conversationHistory[0]?.parts?.[0]?.text?.substring(0, 30) || langData.defaultChatTitle; // Tytuł z pierwszej wiadomości lub domyślny
                 addChatToList(currentChatId, chatTitle); // Dodaj do listy czatów
            }

            if (currentChatId) {
                 const historyToSave = conversationHistory.map(msg => {
                     if (msg.role === 'user' && msg.parts.some(part => part.inline_data)) {
                         const textPart = msg.parts.find(part => part.text);
                         return {
                             role: msg.role,
                             parts: textPart ? [textPart] : []
                         };
                     }
                     return msg;
                }).filter(msg => msg.parts.length > 0);

                localStorage.setItem(`chat_${currentChatId}`, JSON.stringify(historyToSave));
                updateChatTitleInList(currentChatId); // Aktualizuj tytuł w liście
            }

        } catch (e) {
            console.error("Could not save current history to Local Storage:", e);
        }
    }

    // Funkcja do ładowania historii z Local Storage na podstawie ID
    function loadHistory(chatId) {
        try {
            const savedHistory = localStorage.getItem(`chat_${chatId}`);
            if (savedHistory) {
                conversationHistory = JSON.parse(savedHistory);
                chat.innerHTML = ''; // Wyczyść aktualny widok czatu
                conversationHistory.forEach(msg => {
                    if (msg.role === 'user') {
                         // Sprawdź, czy wiadomość użytkownika zawiera obraz
                         const textPart = msg.parts.find(part => part.text);
                         const imagePart = msg.parts.find(part => part.inline_data);

                         if (textPart) {
                             appendMessage(textPart.text, 'user');
                         }
                         if (imagePart) {
                             // Ponowne generowanie HTML dla obrazu
                             const imgHtml = `<img src="data:${imagePart.inline_data.mime_type};base64,${imagePart.inline_data.data}" alt="${translations[currentLanguage]?.sentImageAlt || translations['en'].sentImageAlt}" class="inline-block max-w-[80%] max-h-[100px] rounded-lg my-2">`;
                             appendMessage(imgHtml, 'user', true);
                         }

                    } else if (msg.role === 'model') {
                        appendMessage(msg.parts[0].text, 'bot');
                    }
                });
                chat.scrollTop = chat.scrollHeight;
                currentChatId = chatId; // Ustaw aktualne ID czatu
                highlightActiveChat(chatId); // Podświetl aktywny czat w liście
            } else {
                 console.warn(`Chat history with ID ${chatId} not found.`);
                 startNewChat(); // Jeśli nie znaleziono, zacznij nowy czat
            }
        } catch (e) {
            console.error("Could not load history from Local Storage:", e);
            conversationHistory = [];
            startNewChat(); // W przypadku błędu, zacznij nowy czat
        }
    }

    // Funkcja do zarządzania listą czatów w Local Storage
    function getChatList() {
        try {
            const chatList = localStorage.getItem(LOCAL_STORAGE_CHAT_LIST_KEY);
            return chatList ? JSON.parse(chatList) : [];
        } catch (e) {
            console.error("Could not get chat list from Local Storage:", e);
            return [];
        }
    }

    function saveChatList(chatList) {
        try {
            localStorage.setItem(LOCAL_STORAGE_CHAT_LIST_KEY, JSON.stringify(chatList));
        } catch (e) {
            console.error("Could not save chat list to Local Storage:", e);
        }
    }

    // Funkcja do dodawania nowego czatu do listy
    function addChatToList(chatId, title) {
        const chatList = getChatList();
        // Sprawdź, czy czat o tym ID już istnieje
        if (!chatList.find(chat => chat.id === chatId)) {
            chatList.unshift({ id: chatId, title: title }); // Dodaj na początek listy
            saveChatList(chatList);
            renderChatList(); // Odśwież widok listy
        }
    }

     // Funkcja do aktualizacji tytułu czatu w liście (np. po pierwszej wiadomości)
     function updateChatTitleInList(chatId) {
         const chatList = getChatList();
         const chatIndex = chatList.findIndex(chat => chat.id === chatId);
         if (chatIndex !== -1) {
             const savedHistory = localStorage.getItem(`chat_${chatId}`);
             if (savedHistory) {
                 try {
                     const history = JSON.parse(savedHistory);
                     const langData = translations[currentLanguage] || translations['en'];
                     // Znajdź pierwszą wiadomość użytkownika z tekstem, aby użyć jej jako tytułu
                     const firstUserMessage = history.find(msg => msg.role === 'user' && msg.parts.some(part => part.text));
                     const newTitle = firstUserMessage?.parts.find(part => part.text)?.text.substring(0, 30) || langData.defaultChatTitle;

                     if (chatList[chatIndex].title !== newTitle) {
                         chatList[chatIndex].title = newTitle;
                         saveChatList(chatList);
                         renderChatList(); // Odśwież widok listy, jeśli tytuł się zmienił
                     }
                 } catch (e) {
                     console.error("Error parsing history for title update:", e);
                 }
             }
         }
     }


    // Funkcja do renderowania listy czatów w panelu bocznym
    function renderChatList() {
        const chatList = getChatList();
        chatHistoryList.innerHTML = ''; // Wyczyść aktualną listę

        chatList.forEach(chatItem => {
            const chatElement = document.createElement('div');
            chatElement.className = 'chat-history-item';
            if (chatItem.id === currentChatId) {
                 chatElement.classList.add('active'); // Podświetl aktywny czat
            }
            chatElement.innerText = chatItem.title;
            chatElement.dataset.chatId = chatItem.id; // Zapisz ID czatu w elemencie

            chatElement.addEventListener('click', () => {
                // Zapisz aktualny czat przed załadowaniem innego
                if (conversationHistory.length > 0 && currentChatId) {
                     saveCurrentHistory();
                } else if (conversationHistory.length > 0 && !currentChatId) {
                     // Jeśli to nowa rozmowa bez ID, ale z wiadomościami, zapisz ją
                     saveCurrentHistory();
                }
                loadHistory(chatItem.id); // Załaduj historię klikniętego czatu
                toggleSidebar(); // Zamknij panel po kliknięciu
            });

            chatHistoryList.appendChild(chatElement);
        });
    }

    // Funkcja do podświetlania aktywnego czatu w liście
    function highlightActiveChat(chatId) {
        const items = chatHistoryList.querySelectorAll('.chat-history-item');
        items.forEach(item => {
            item.classList.remove('active');
            if (item.dataset.chatId === chatId) {
                item.classList.add('active');
            }
        });
    }


    // Function to start a new chat (z czyszczeniem Local Storage dla aktualnego czatu)
    function startNewChat() {
        // Zapisz aktualny czat przed rozpoczęciem nowego
        if (conversationHistory.length > 0 && currentChatId) {
             saveCurrentHistory();
        } else if (conversationHistory.length > 0 && !currentChatId) {
             // Jeśli była to nowa rozmowa bez ID, ale z wiadomościami, zapisz ją
             saveCurrentHistory();
        }


        conversationHistory = [];
        chat.innerHTML = ''; // Wyczyść widok czatu
        currentChatId = null; // Zresetuj aktualne ID czatu
        localStorage.removeItem(LOCAL_STORAGE_CURRENT_HISTORY_KEY); // Opcjonalnie usuń starą "aktualną" historię

        messageInput.focus();
        imageInput.value = null;
        imagePreview.classList.add('hidden');
        imagePreview.src = '#';

        renderChatList(); // Odśwież listę czatów (żeby usunąć podświetlenie)
        toggleSidebar(); // Zamknij panel po kliknięciu
    }


    // Funkcja do konwersji pliku obrazu na base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // Function to handle sending messages to the Gemini API
    async function sendMessage(message) {
      const langData = translations[currentLanguage] || translations['en'];
      const imageFile = imageInput.files[0];

      if (!message.trim() && !imageFile) return;

      let currentUserTurnParts = [];

      if (message.trim()) {
        currentUserTurnParts.push({ text: message });
        appendMessage(message, 'user');
      }

      if (imageFile) {
        try {
          const base64Data = await fileToBase64(imageFile);
          currentUserTurnParts.push({
            inline_data: {
              mime_type: imageFile.type,
              data: base64Data
            }
          });
          const imgHtml = `<img src="data:${imageFile.type};base64,${base64Data}" alt="${langData.sentImageAlt}" class="inline-block max-w-[80%] max-h-[100px] rounded-lg my-2">`;
          appendMessage(imgHtml, 'user', true);

        } catch (e) {
          console.error("Error processing image:", e);
          appendMessage(`${langData.imageProcessingError}: ${e.message}`, 'bot');
          if (!message.trim()) {
            sendBtn.disabled = false;
            messageInput.disabled = false;
            sidebarToggleBtn.disabled = false; // Włącz przycisk panelu
            sidebarNewChatBtn.disabled = false; // Włącz przycisk Nowy Czat w panelu
            attachButton.disabled = false;
            messageInput.focus();
            return;
          }
          currentUserTurnParts = currentUserTurnParts.filter(part => !part.inline_data);
        } finally {
          imageInput.value = null;
          imagePreview.classList.add('hidden');
          imagePreview.src = '#';
        }
      }

      if (currentUserTurnParts.length === 0) {
          sendBtn.disabled = false;
          messageInput.disabled = false;
          sidebarToggleBtn.disabled = false; // Włącz przycisk panelu
          sidebarNewChatBtn.disabled = false; // Włącz przycisk Nowy Czat w panelu
          attachButton.disabled = false;
          messageInput.focus();
          return;
      }

      messageInput.value = '';
      sendBtn.disabled = true;
      messageInput.disabled = true;
      sidebarToggleBtn.disabled = true; // Wyłącz przycisk panelu
      sidebarNewChatBtn.disabled = true; // Wyłącz przycisk Nowy Czat w panelu
      attachButton.disabled = true;

      appendLoadingIndicator();
      vibrateDevice([50]); // Wibracja przy wysyłaniu

      try {
        const modelToUse = 'gemini-1.5-flash';

        const temperature = currentTemperature;

        // System instruction should be in the selected language
        const systemInstructionParts = [{ text: translations[currentLanguage]?.systemMessage || translations['en'].systemMessage }];

        const apiContents = [
            ...conversationHistory,
            { role: 'user', parts: currentUserTurnParts }
        ];

        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: apiContents,
            system_instruction: { parts: systemInstructionParts },
            generationConfig: { temperature: temperature }
          })
        });

        if (!res.ok) {
          const errorData = await res.json();
          let displayErrorMessage = langData.errorApi;

          if (errorData.error && errorData.error.message) {
            displayErrorMessage += `: ${errorData.error.message}`;
          } else {
            if (res.status === 400) {
               displayErrorMessage += `: ${langData.errorApiRequest}`;
            } else if (res.status === 401) {
               displayErrorMessage += `: ${langData.errorApiAuth}`;
            } else if (res.status === 429) {
               displayErrorMessage += `: ${langData.errorApiQuota}`;
            } else if (res.status >= 500) {
               displayErrorMessage = langData.errorApiServer(res.status);
            } else {
               displayErrorMessage += ` (Kod statusu: ${res.status})`;
            }
          }
          throw new Error(displayErrorMessage);
        }

        const data = await res.json();
        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text;

        removeLoadingIndicator();

        if (!reply) {
            console.warn("Gemini returned no text reply:", data);
            appendMessage(langData.errorNoReply, 'bot');
            const userHistoryTurn = { role: 'user', parts: currentUserTurnParts.filter(part => part.text) };
            if (userHistoryTurn.parts.length > 0) conversationHistory.push(userHistoryTurn);
            conversationHistory.push({ role: 'model', parts: [{ text: langData.errorNoReply }] });
            saveCurrentHistory(); // Zapisz historię nawet z błędem
        } else {
            const userHistoryTurn = { role: 'user', parts: currentUserTurnParts.filter(part => part.text) };
            // Dodaj do historii tylko tekstową część wiadomości użytkownika, jeśli zawiera obraz
            const historyUserParts = currentUserTurnParts.filter(part => part.text || part.inline_data);
             if (historyUserParts.length > 0) {
                 // Zapisz pełne części (tekst + obraz) w historii
                 conversationHistory.push({ role: 'user', parts: historyUserParts });
             }

            conversationHistory.push({ role: 'model', parts: [{ text: reply }] });

            appendMessage(reply, 'bot');
            vibrateDevice([100]); // Wibracja przy odbieraniu
            saveCurrentHistory(); // Zapisz historię po udanej odpowiedzi
        }

        // Ograniczenie historii rozmowy
        if (conversationHistory.length > HISTORY_LIMIT * 2) { // Limit dotyczy par user/model, więc 20 tur to 40 wiadomości
            conversationHistory = conversationHistory.slice(conversationHistory.length - HISTORY_LIMIT * 2);
        }

      } catch (err) {
        removeLoadingIndicator();
        console.error('Wystąpił błąd komunikacji z Gemini API:', err);
        appendMessage(`${langData.errorApi}: ${err.message || langData.errorGeneric}`, 'bot');
        const userHistoryTurn = { role: 'user', parts: currentUserTurnParts.filter(part => part.text) };
        if (userHistoryTurn.parts.length > 0) conversationHistory.push(userHistoryTurn);
        conversationHistory.push({ role: 'model', parts: [{ text: `${langData.errorApi}: ${err.message || langData.errorGeneric}` }] });
        saveCurrentHistory(); // Zapisz historię nawet z błędem

         // Ograniczenie historii rozmowy
         if (conversationHistory.length > HISTORY_LIMIT * 2) {
             conversationHistory = conversationHistory.slice(conversationHistory.length - HISTORY_LIMIT * 2);
         }

      } finally {
        sendBtn.disabled = false;
        messageInput.disabled = false;
        sidebarToggleBtn.disabled = false; // Włącz przycisk panelu
        sidebarNewChatBtn.disabled = false; // Włącz przycisk Nowy Czat w panelu
        attachButton.disabled = false;
        messageInput.focus();
      }
    }

    // Funkcja do wysyłania informacji o wizycie na stronę do Discorda
    async function sendVisitInfoToDiscord() {
        try {
            // Próba uzyskania IP użytkownika (nie zawsze dokładne/dostępne)
            const ipResponse = await fetch('https://api64.ipify.org?format=json');
            const ipData = await ipResponse.json();
            const userIp = ipData.ip || 'N/A';

            const messageContent = `Ktoś wszedł na stronę Jurek36AI ChatBot 2.0. IP: ${userIp}`;

            const discordResponse = await fetch(DISCORD_WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: messageContent
                }),
            });

            if (!discordResponse.ok) {
                console.error('Błąd podczas wysyłania informacji do Discorda:', discordResponse.status, discordResponse.statusText);
            } else {
                console.log('Informacja o wizycie wysłana do Discorda.');
            }
        } catch (error) {
            console.error('Wystąpił błąd podczas wysyłania informacji o wizycie:', error);
        }
    }

    // Funkcja do przełączania widoczności panelu bocznego
    function toggleSidebar() {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('visible');
        // Opcjonalnie: dodaj/usuń klasę do głównego kontenera, aby przesunąć główną treść
        // document.getElementById('main-container').classList.toggle('sidebar-open');
    }


    // Nasłuchiwacz zdarzeń dla przycisku przełączającego kreatywność
    creativityToggleBtn.addEventListener('click', () => {
        if (currentTemperature === DEFAULT_TEMPERATURE) {
            currentTemperature = MAX_TEMPERATURE;
        } else {
            currentTemperature = DEFAULT_TEMPERATURE;
        }
        updateCreativityButtonState();
        console.log("Kreatywność ustawiona na:", currentTemperature);
    });

    // Nasłuchiwacz zdarzeń dla przycisku otwierającego panel boczny
    sidebarToggleBtn.addEventListener('click', toggleSidebar);

    // Nasłuchiwacz zdarzeń dla overlay (kliknięcie poza panelem zamyka go)
    overlay.addEventListener('click', toggleSidebar);

    // Nasłuchiwacz zdarzeń dla przycisku "Nowy Czat" w panelu bocznym
    sidebarNewChatBtn.addEventListener('click', startNewChat);

    // Nasłuchiwacz zdarzeń dla pola wyboru obrazu
    imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        } else {
            imagePreview.classList.add('hidden');
            imagePreview.src = '#';
        }
    });

    // Nasłuchiwacz zdarzeń dla przycisku spinacza
    attachButton.addEventListener('click', () => {
        imageInput.click();
    });

    // Event listeners dla wysyłania wiadomości
    sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
    messageInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        sendMessage(messageInput.value);
      }
    });

    // Nasłuchiwacz zdarzeń dla zmiany języka w selektorze
    languageSelect.addEventListener('change', (event) => {
        currentLanguage = event.target.value;
        localStorage.setItem(LOCAL_STORAGE_LANGUAGE_KEY, currentLanguage); // Zapisz wybrany język
        applyLanguageToUI(); // Zastosuj nowy język do UI
        // Opcjonalnie: przeładuj historię czatu, aby przetłumaczyć sugerowane pytania
        if (currentChatId) {
            loadHistory(currentChatId);
        }
    });


    // Set focus on the input field after page load
    messageInput.focus();

    // Inicjalizacja po załadowaniu strony
    window.onload = async function () {
        await detectAndSetLanguage(); // Wykryj lub wczytaj język przed załadowaniem historii
        // Spróbuj załadować ostatnio aktywny czat lub zacznij nowy
        const lastChatId = localStorage.getItem('jurek36ai_last_chat_id');
        if (lastChatId) {
            loadHistory(lastChatId);
        } else {
            startNewChat(); // Zaczyna nowy czat, co też renderuje listę
        }
        updateCreativityButtonState();
        sendVisitInfoToDiscord(); // Wyślij informację o wizycie na stronę
        renderChatList(); // Upewnij się, że lista czatów jest wyrenderowana przy starcie
    };

    // Dodaj nasłuchiwacz zdarzeń kliknięcia do elementu chat dla delegacji przycisków kopiowania
    addCopyButtonListeners(chat);

    // Zapisz aktualne ID czatu przed zamknięciem strony
    window.addEventListener('beforeunload', () => {
        if (currentChatId) {
            localStorage.setItem('jurek36ai_last_chat_id', currentChatId);
            saveCurrentHistory(); // Zapisz aktualną rozmowę
        } else if (conversationHistory.length > 0) {
             // Jeśli była nowa rozmowa bez ID, ale z wiadomościami, zapisz ją
             saveCurrentHistory();
             if (currentChatId) { // Sprawdź, czy saveCurrentHistory nadało ID
                 localStorage.setItem('jurek36ai_last_chat_id', currentChatId);
             }
        } else {
             localStorage.removeItem('jurek36ai_last_chat_id');
        }
    });


  </script>
</body>
</html>
